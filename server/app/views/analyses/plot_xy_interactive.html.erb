<h2>Analysis Results &mdash; <%= link_to @analysis.name, analysis_path(@analysis) %></h2>


<% if @plot_data %>
  <div id="xy-div">
    <p>There are no results for this analysis.</p>
  </div>
<% else %>

  <%= javascript_tag do %>
    variables = <%=raw @variables.to_json %>;
  <% end %>

  <div id="xy-div">
    <script>

      var margin = {top: 20, right: 20, bottom: 30, left: 40},
          width = 900 - margin.left - margin.right,
          height = 500 - margin.top - margin.bottom;

      var x = d3.scale.linear()
          .range([0, width]);

      var y = d3.scale.linear()
          .range([height, 0]);

      var color = d3.scale.category20();

      var xAxis = d3.svg.axis()
          .scale(x)
          .orient("bottom");

      var yAxis = d3.svg.axis()
          .scale(y)
          .orient("left");

      var tooltip = d3.select("body")
          .append("div")
          .style("position", "absolute")
          .style("z-index", "10")
          .style("visibility", "hidden")
          .text("na");

      var svg = d3.select("#xy-div").append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      d3.json(encodeURI("plot_data_xy.json?variables=" + variables), function (error, data) {

            console.log(data['plotvars'][0])
            x_variable = data['plotvars'][0]
            x.domain(d3.extent(data['data'], function (d) {
              return d[data['plotvars'][0]];
            })).nice();


            y_variable = data['plotvars'][1]
            y.domain(d3.extent(data['data'], function (d) {
              return d[data['plotvars'][1]];
            })).nice();


        svg.append("g")
            .attr("class", "x axis")
            .attr("transform", "translate(0," + height + ")")
            .call(xAxis)
            .append("text")
            .attr("class", "label")
            .attr("x", width)
            .attr("y", -6)
            .style("text-anchor", "end")
            .text(x_variable);

        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .append("text")
            .attr("class", "label")
            .attr("transform", "rotate(-90)")
            .attr("y", 6)
            .attr("dy", ".71em")
            .style("text-anchor", "end")
            .text(y_variable)

        svg.selectAll("circle")
            .data(data['data'])
            .enter().append("svg:circle")
            .attr("class", "dot")
            .attr("r", 6)
            .attr("cx", function (d) {
              return x(d[x_variable]);
            })
            .attr("cy", function (d) {
              return y(d[y_variable]);
            })
            .style("fill",function (d) {
              return color(d.iteration);
            }).on("click", function (d) {
              return tooltip.style("visibility", "visible")
                  .style("background", "white")
                  .style("border-style", "solid")
                  .style("border-width", "1px")
                  .style("top", (event.pageY - 10) + "px").style("left", (event.pageX + 10) + "px")
                  .html("X: " + d[x_variable].toFixed(2) +
                      "</br>Y: " + d[y_variable].toFixed(2) +
                      "</br>url: <a href=" + d.data_point_uuid + ">View Data Point</a>");
            });


      });

    </script>

  </div>

  <div id="chart-form">
    <div class="chart-text">
      <p>Select the x and y variables to plot below.</p>
      <div class="row-fluid">
        <%= form_tag("/analyses/#{@analysis.id}/plot_xy_interactive") do  %>
          <div class="span5">
            <fieldset>
            <%= label_tag("variables[x]", "X axis:") %>
            <%= select_tag "variables[x]", options_for_select(@allvars, @variables.first) %>
            </fieldset>
            <fieldset>
            <%= label_tag("variables[y]", "Y axis:") %>
            <%= select_tag "variables[y]", options_for_select(@allvars, @variables.last) %>
            </fieldset>
            <p>
            <div class="submit-form"> <%= submit_tag "Update Chart" %>  </div>
            </p>
          </div>
        <% end %>

      </div>
    </div>
  </div>


<% end %>




