name: openstudio-server

on:
  # Trigger the workflow on push or pull request,
  # but only for the main branch
  push:
    branches:
      - setup_github_actions
#on:
#  pull_request:
#    branches: [ master, develop ]

env:
  USE_TESTING_TIMEOUTS: "true"
  OPENSTUDIO_VERSION: 3.1.0 
  OPENSTUDIO_VERSION_SHA: e165090621 
  OPENSTUDIO_VERSION_EXT: ""
  DOCKER_COMPOSE_VERSION: 1.21.1
  BUNDLE_WITHOUT: native_ext


jobs:
  test:
    runs-on: ubuntu-18.04
    steps: 
    - name: Check out repository
      uses: actions/checkout@v2
    - name: setup
      shell: bash 
      run: ./ci/github-actions/setup.sh
      env:
        BUILD_TYPE: test
    - name: test
      shell: bash 
      run: ./ci/github-actions/test.sh
      env:
        BUILD_TYPE: test
    - name: logs
      if: ${{ failure() }}
      shell: bash 
      run: ./ci/github-actions/print_logs.sh
      env:
        BUILD_TYPE: test
  integration:
    runs-on: ubuntu-18.04
    steps: 
    - name: Check out repository
      uses: actions/checkout@v2
    - name: setup
      shell: bash 
      run: ./ci/github-actions/setup.sh
      env:
        BUILD_TYPE: integration
    - name: test
      shell: bash 
      run: ./ci/github-actions/test.sh
      env:
        BUILD_TYPE: integration
    - name: logs
      if: ${{ failure() }}
      shell: bash 
      run: ./ci/github-actions/print_logs.sh
  docker:
    runs-on: ubuntu-18.04
    steps: 
    - name: Check out repository
      uses: actions/checkout@v2
    - name: docker
      shell: bash 
      run: |
          export OPENSTUDIO_TAG=develop
          sed -i -E "s/.git//g" .dockerignore
          docker volume create --name=osdata
          docker images --all
          docker --version
          docker-compose --version
          docker-compose -f docker-compose.test.yml pull
          docker-compose -f docker-compose.test.yml build --build-arg OPENSTUDIO_VERSION=$OPENSTUDIO_TAG
          docker-compose -f docker-compose.test.yml up -d
          docker-compose exec web /usr/local/bin/run-server-tests
          docker-compose stop
          git checkout -- .dockerignore && git checkout -- Dockerfile
      env: 
        COMPOSE_INTERACTIVE_NO_CLI: 1
        CI: true
        OS_SERVER_NUMBER_OF_WORKERS: 4
        BUILD_TYPE: docker
    - name: logs
      if: ${{ failure() }}
      shell: bash 
      run: ./ci/github-actions/print_logs.sh
 
#after_failure: ./ci/travis/print_logs.sh

# Services for linux -- all instances
#services:
#  - docker

