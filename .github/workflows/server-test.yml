name: openstudio-server

on:
  # Trigger the workflow on push or pull request,
  # but only for the main branch
  push:
    branches:
      - setup_github_actions
#on:
#  pull_request:
#    branches: [ master, develop ]

env:
  USE_TESTING_TIMEOUTS: "true"
  OPENSTUDIO_VERSION: 3.1.0 
  OPENSTUDIO_VERSION_SHA: e165090621 
  OPENSTUDIO_VERSION_EXT: ""
  DOCKER_COMPOSE_VERSION: 1.21.1
  BUNDLE_WITHOUT: native_ext


jobs:
#  test:
#    runs-on: ubuntu-18.04
#    steps: 
#    - name: Check out repository
#      uses: actions/checkout@v2
#    - name: setup
#      shell: bash 
#      run: ./ci/github-actions/setup.sh
#      env:
#        BUILD_TYPE: test
#    - name: test
#      shell: bash 
#      run: ./ci/github-actions/test.sh
#      env:
#        BUILD_TYPE: test
#    - name: logs
#      if: ${{ failure() }}
#      shell: bash 
#      run: ./ci/github-actions/print_logs.sh
#      env:
#       BUILD_TYPE: test
#  integration:
#    runs-on: ubuntu-18.04
#    steps: 
#    - name: Check out repository
#      uses: actions/checkout@v2
#    - name: setup
#      shell: bash 
#      run: ./ci/github-actions/setup.sh
#      env:
#        BUILD_TYPE: integration
#    - name: test
#      shell: bash 
#      run: ./ci/github-actions/test.sh
#      env:
#        BUILD_TYPE: integration
#    - name: logs
#      if: ${{ failure() }}
#      shell: bash 
#      run: ./ci/github-actions/print_logs.sh
#  docker:
#   runs-on: ubuntu-18.04
#    steps: 
#    - name: Check out repository
#      uses: actions/checkout@v2
  macos-test:
    runs-on: macos-10.15
    steps: 
    - name: Check out repository
      uses: actions/checkout@v2
    - name: setup
      shell: bash 
      run: ./ci/github-actions/setup.sh
    - name: unit-test
      shell: bash 
      run: ./ci/github-actions/test.sh
      env:
        BUILD_TYPE: test
    - name: integration
      shell: bash 
      run: ./ci/github-actions/test.sh
      env:
        BUILD_TYPE: integration
    - name: logs
      shell: bash 
      run: ./ci/github-actions/print_logs.sh
    - name: build gem package
      if: ${{ success() }}  
      shell: bash 
      run: ./ci/github-actions/export_build_osx.sh
    - name: upload gem package
      if: ${{ success() }} 
    - uses: actions/upload-artifact@v2
      with:
        name: openstudio-server-gems
        path: build/NREL/export/*.tar.gz


  

 #   - name: docker
 #     shell: bash 
 #     run: |
 #         export OPENSTUDIO_TAG=develop
 #         sed -i -E "s/.git//g" .dockerignore
 #         docker volume create --name=osdata
 #         docker images --all
 #         docker --version
 #         docker-compose --version
 #         docker-compose -f docker-compose.test.yml pull
 #         docker-compose -f docker-compose.test.yml build --build-arg OPENSTUDIO_VERSION=$OPENSTUDIO_TAG
 #         docker-compose -f docker-compose.test.yml up -d
 #         docker-compose exec -T web /usr/local/bin/run-server-tests
 #         docker-compose stop
 #         git checkout -- .dockerignore && git checkout -- Dockerfile
 #     env: 
 #       CI: true
 #       OS_SERVER_NUMBER_OF_WORKERS: 4
 #       BUILD_TYPE: docker
 #       COMPOSE_INTERACTIVE_NO_CLI: 1
 #   - name: logs
 #     if: ${{ failure() }}
 #     shell: bash 
 #     run: ./ci/github-actions/print_logs.sh
 
  publish-macos:
    needs: [integration-macos, job2]
    runs-on: macos-10.15
    steps: 
    - name: Check out repository
      uses: actions/checkout@v2
    - name: setup
      shell: bash 
      run: ./ci/github-actions/setup.sh


  - stage: publish
      # Include your branch name below to publish a custom image.
      # This change must be made in combination with a modification to
      # deployment/scripts/deploy_docker.sh, as indicated in comments for that file.
      # Full documentation at https://github.com/NREL/OpenStudio-server/wiki/Contributor-Docs:-Building-and-Publishing-Docker-images
      if: branch = master OR branch = develop
      os: linux
      sudo: required
      dist: bionic
      env:
        - BUILD_TYPE=docker
      before_script:
        #- export OPENSTUDIO_TAG=$(ruby -e "load 'server/app/lib/openstudio_server/version.rb'; print OpenstudioServer::VERSION+OpenstudioServer::VERSION_EXT")
        - export OPENSTUDIO_TAG=develop
        - docker images --all
        - docker --version
        - docker-compose --version
        - docker volume create --name=osdata
        - docker-compose build --build-arg OPENSTUDIO_VERSION=$OPENSTUDIO_TAG web
        - docker-compose build rserve
      script: ./docker/deployment/scripts/deploy_docker.sh
    - stage: publish
      if: branch = master OR branch = develop
      os: osx
      osx_image: xcode10.2
      sudo: required
      env:
        - BUILD_TYPE=export
      before_script:
      script: ./ci/travis/export_build_osx.sh
    - stage: publish
      if: branch = master OR branch = develop
      os: linux
      dist: bionic
      sudo: required
      env:
        - BUILD_TYPE=export
      before_script:
      script: ./ci/travis/export_build_linux.sh